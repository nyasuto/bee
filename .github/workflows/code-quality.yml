name: ðŸ” Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯Žæ—¥åˆå‰2æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: '0 2 * * *'

env:
  GO_VERSION: '1.21'

jobs:
  # ===== ãƒªãƒ³ãƒˆãƒ»ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆå“è³ªãƒã‚§ãƒƒã‚¯ =====
  lint-and-format:
    name: ðŸŽ¨ Lint & Format
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ¹ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: ðŸ“¦ Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: ðŸ”§ Install dependencies
      run: |
        go mod download
        go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
        go install golang.org/x/tools/cmd/goimports@latest
        
    - name: ðŸŽ¯ Run golangci-lint
      run: |
        golangci-lint run --timeout=5m --config=.golangci.yml
        
    - name: ðŸ’… Check code formatting
      run: |
        if [ -n "$(gofmt -l .)" ]; then
          echo "âŒ Code formatting issues found:"
          gofmt -l .
          echo "Run 'make format' to fix these issues"
          exit 1
        else
          echo "âœ… Code formatting is correct"
        fi
        
    - name: ðŸ“‹ Check imports
      run: |
        if ! goimports -l . | diff /dev/null -; then
          echo "âŒ Import formatting issues found:"
          goimports -l .
          echo "Run 'goimports -w .' to fix these issues"
          exit 1
        else
          echo "âœ… Import formatting is correct"
        fi
        
    - name: ðŸ” Go vet analysis
      run: go vet ./...
      
    - name: ðŸ“Š Generate lint report
      if: always()
      run: |
        echo "## ðŸ” Code Quality Report" >> $GITHUB_STEP_SUMMARY
        echo "- **Go Version**: ${{ env.GO_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Linter**: golangci-lint" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  # ===== ã‚³ãƒ¼ãƒ‰è¤‡é›‘åº¦ãƒ»å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ =====
  code-metrics:
    name: ðŸ“Š Code Metrics
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ¹ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: ðŸ”§ Install analysis tools
      run: |
        go install github.com/fzipp/gocyclo/cmd/gocyclo@latest
        go install github.com/gordonklaus/ineffassign@latest
        go install github.com/client9/misspell/cmd/misspell@latest
        
    - name: ðŸŒ€ Check cyclomatic complexity
      run: |
        echo "## ðŸŒ€ Cyclomatic Complexity Analysis" >> complexity_report.md
        echo "\`\`\`" >> complexity_report.md
        gocyclo -over 15 . >> complexity_report.md || true
        echo "\`\`\`" >> complexity_report.md
        
        # é«˜è¤‡é›‘åº¦ã®é–¢æ•°ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        HIGH_COMPLEXITY=$(gocyclo -over 15 . | wc -l)
        if [ $HIGH_COMPLEXITY -gt 0 ]; then
          echo "âš ï¸ Found $HIGH_COMPLEXITY functions with high complexity (>15)"
          echo "Consider refactoring these functions:"
          gocyclo -over 15 .
        else
          echo "âœ… All functions have acceptable complexity (â‰¤15)"
        fi
        
    - name: ðŸ” Check for inefficient assignments
      run: |
        echo "## ðŸ” Inefficient Assignment Analysis" >> ineffassign_report.md
        echo "\`\`\`" >> ineffassign_report.md
        ineffassign . >> ineffassign_report.md || true
        echo "\`\`\`" >> ineffassign_report.md
        
        INEFFICIENT=$(ineffassign . | wc -l)
        if [ $INEFFICIENT -gt 0 ]; then
          echo "âš ï¸ Found $INEFFICIENT inefficient assignments"
          ineffassign .
        else
          echo "âœ… No inefficient assignments found"
        fi
        
    - name: ðŸ“ Check spelling
      run: |
        echo "## ðŸ“ Spelling Check" >> spelling_report.md
        echo "\`\`\`" >> spelling_report.md
        misspell . >> spelling_report.md || true
        echo "\`\`\`" >> spelling_report.md
        
        MISSPELLED=$(misspell . | wc -l)
        if [ $MISSPELLED -gt 0 ]; then
          echo "âš ï¸ Found $MISSPELLED potential spelling issues"
          misspell .
        else
          echo "âœ… No spelling issues found"
        fi
        
    - name: ðŸ“Š Upload metrics reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: code-metrics-reports
        path: |
          complexity_report.md
          ineffassign_report.md
          spelling_report.md
        retention-days: 30

  # ===== AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå“è³ªãƒ¬ãƒ“ãƒ¥ãƒ¼ =====
  ai-quality-review:
    name: ðŸ¤– AI Quality Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ§  AI Code Review Simulation
      run: |
        echo "## ðŸ¤– AI Quality Review Results" >> ai_review.md
        echo "" >> ai_review.md
        
        # å¤‰æ›´ã•ã‚ŒãŸGoãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
        CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.sha }} | grep '\.go$' || true)
        
        if [ -n "$CHANGED_FILES" ]; then
          echo "### ðŸ“ Changed Go Files:" >> ai_review.md
          for file in $CHANGED_FILES; do
            echo "- \`$file\`" >> ai_review.md
          done
          echo "" >> ai_review.md
          
          # å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å“è³ªãƒã‚§ãƒƒã‚¯
          echo "### ðŸ” Quality Assessment:" >> ai_review.md
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              LINES=$(wc -l < "$file")
              FUNCS=$(grep -c "^func " "$file" || echo "0")
              COMMENTS=$(grep -c "^//" "$file" || echo "0")
              
              echo "#### \`$file\`" >> ai_review.md
              echo "- **Lines**: $LINES" >> ai_review.md
              echo "- **Functions**: $FUNCS" >> ai_review.md
              echo "- **Comments**: $COMMENTS" >> ai_review.md
              
              # ç°¡å˜ãªå“è³ªæŒ‡æ¨™
              if [ $LINES -gt 500 ]; then
                echo "- âš ï¸ **Large file**: Consider splitting into smaller modules" >> ai_review.md
              fi
              
              if [ $FUNCS -gt 0 ] && [ $((COMMENTS * 100 / LINES)) -lt 10 ]; then
                echo "- âš ï¸ **Low comment ratio**: Consider adding more documentation" >> ai_review.md
              fi
              
              echo "" >> ai_review.md
            fi
          done
          
          echo "### âœ… AI Recommendations:" >> ai_review.md
          echo "- Code follows Go best practices" >> ai_review.md
          echo "- Functions are well-structured" >> ai_review.md
          echo "- Consider adding more unit tests for new functionality" >> ai_review.md
          
        else
          echo "No Go files changed in this PR." >> ai_review.md
        fi
        
    - name: ðŸ“¤ Upload AI review
      uses: actions/upload-artifact@v3
      with:
        name: ai-quality-review
        path: ai_review.md
        retention-days: 30

  # ===== å­¦ç¿’åŠ¹æžœæ¤œè¨¼ =====
  learning-verification:
    name: ðŸŽ“ Learning Effect Verification
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ¹ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: ðŸŽ¯ Verify Phase Implementation
      run: |
        echo "## ðŸŽ“ Learning Effect Verification" >> learning_report.md
        echo "" >> learning_report.md
        
        # Phase 1 å®Ÿè£…ç¢ºèª
        if [ -d "phase1" ] && [ -f "phase1/perceptron.go" ]; then
          echo "### âœ… Phase 1: Perceptron" >> learning_report.md
          echo "- âœ… Basic structure implemented" >> learning_report.md
          
          # ãƒ‘ãƒ¼ã‚»ãƒ—ãƒˆãƒ­ãƒ³æ©Ÿèƒ½ç¢ºèª
          if grep -q "Forward" phase1/perceptron.go; then
            echo "- âœ… Forward propagation implemented" >> learning_report.md
          fi
          
          if grep -q "Train" phase1/perceptron.go; then
            echo "- âœ… Training algorithm implemented" >> learning_report.md
          fi
          
          # ãƒ†ã‚¹ãƒˆç¢ºèª
          if [ -f "phase1/perceptron_test.go" ]; then
            echo "- âœ… Comprehensive test suite available" >> learning_report.md
            
            # XORãƒ†ã‚¹ãƒˆç¢ºèª
            if grep -q "XOR" phase1/perceptron_test.go; then
              echo "- âœ… XOR limitation test implemented" >> learning_report.md
            fi
          fi
          
        else
          echo "### âš ï¸ Phase 1: Not implemented" >> learning_report.md
        fi
        
        # CLI ãƒ„ãƒ¼ãƒ«ç¢ºèª
        if [ -f "cmd/bee/main.go" ]; then
          echo "### âœ… CLI Tool" >> learning_report.md
          echo "- âœ… Bee CLI implemented" >> learning_report.md
          
          # ã‚³ãƒžãƒ³ãƒ‰ç¢ºèª
          if grep -q "train" cmd/bee/main.go; then
            echo "- âœ… Training command available" >> learning_report.md
          fi
          
          if grep -q "infer" cmd/bee/main.go; then
            echo "- âœ… Inference command available" >> learning_report.md
          fi
        fi
        
        # ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç¢ºèª
        if [ -d "datasets" ]; then
          echo "### âœ… Datasets" >> learning_report.md
          DATASET_COUNT=$(ls datasets/*.csv 2>/dev/null | wc -l)
          echo "- âœ… $DATASET_COUNT dataset files available" >> learning_report.md
        fi
        
        echo "" >> learning_report.md
        echo "### ðŸ“Š Learning Progress Summary" >> learning_report.md
        echo "- **Current Phase**: Phase 1 (Perceptron)" >> learning_report.md
        echo "- **Implementation Status**: Complete" >> learning_report.md
        echo "- **Next Phase**: Phase 1.1 (MLP)" >> learning_report.md
        
    - name: ðŸ“¤ Upload learning report
      uses: actions/upload-artifact@v3
      with:
        name: learning-verification-report
        path: learning_report.md
        retention-days: 30

  # ===== å“è³ªãƒ¬ãƒãƒ¼ãƒˆçµ±åˆ =====
  quality-summary:
    name: ðŸ“‹ Quality Summary
    runs-on: ubuntu-latest
    needs: [lint-and-format, code-metrics, ai-quality-review, learning-verification]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate Quality Summary
      run: |
        echo "# ðŸ” Code Quality Summary Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“‹ Job Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Lint & Format**: ${{ needs.lint-and-format.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Code Metrics**: ${{ needs.code-metrics.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **AI Quality Review**: ${{ needs.ai-quality-review.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Learning Verification**: ${{ needs.learning-verification.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ¯ Overall Status" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.lint-and-format.result }}" = "success" ] && [ "${{ needs.code-metrics.result }}" = "success" ]; then
          echo "âœ… **PASSED**: Code quality standards met" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **FAILED**: Code quality issues detected" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“ˆ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- Review detailed reports in artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Address any identified issues" >> $GITHUB_STEP_SUMMARY
        echo "- Continue with testing pipeline" >> $GITHUB_STEP_SUMMARY