name: ðŸ”’ Security & Dependencies

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯Žæ—¥åˆå‰4æ™‚ï¼ˆUTCï¼‰ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ
    - cron: '0 4 * * *'
    # æ¯Žé€±æœˆæ›œæ—¥ã«ä¾å­˜é–¢ä¿‚æ›´æ–°ãƒã‚§ãƒƒã‚¯
    - cron: '0 6 * * 1'

env:
  GO_VERSION: '1.21'

jobs:
  # ===== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ =====
  security-scan:
    name: ðŸ›¡ï¸ Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ¹ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: ðŸ“¦ Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-security-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-security-
          
    - name: ðŸ”§ Install security tools
      run: |
        # Gosec - Go security checker
        go install github.com/securecodewarrior/github-action-gosec@latest
        curl -sfL https://raw.githubusercontent.com/securecodewarrior/gosec/master/install.sh | sh -s latest
        
        # Nancy - vulnerability scanner for dependencies
        go install github.com/sonatypecom/nancy@latest
        
    - name: ðŸ” Run Gosec security scan
      run: |
        echo "## ðŸ›¡ï¸ Security Scan Results" > security_report.md
        echo "" >> security_report.md
        echo "### ðŸ” Gosec Analysis" >> security_report.md
        echo "\`\`\`" >> security_report.md
        
        # Gosecå®Ÿè¡Œï¼ˆçµæžœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚‚ä¿å­˜ï¼‰
        ./bin/gosec -fmt json -out gosec-report.json ./... 2>/dev/null || true
        ./bin/gosec ./... 2>&1 | tee -a security_report.md || true
        
        echo "\`\`\`" >> security_report.md
        
        # JSONçµæžœã®è§£æž
        if [ -f "gosec-report.json" ]; then
          ISSUES=$(cat gosec-report.json | grep -o '"Issues":\[.*\]' | wc -l)
          echo "" >> security_report.md
          echo "**Summary**: $ISSUES security issues detected" >> security_report.md
        fi
        
    - name: ðŸ”’ Check for hardcoded secrets
      run: |
        echo "" >> security_report.md
        echo "### ðŸ”’ Secret Detection" >> security_report.md
        
        # ç°¡å˜ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³
        SECRET_PATTERNS=(
          "password\s*=\s*['\"][^'\"]{8,}['\"]"
          "api[_-]?key\s*=\s*['\"][^'\"]{20,}['\"]"
          "secret\s*=\s*['\"][^'\"]{16,}['\"]"
          "token\s*=\s*['\"][^'\"]{20,}['\"]"
          "BEGIN RSA PRIVATE KEY"
          "BEGIN PRIVATE KEY"
          "BEGIN OPENSSH PRIVATE KEY"
        )
        
        SECRETS_FOUND=0
        for pattern in "${SECRET_PATTERNS[@]}"; do
          MATCHES=$(grep -r -i -E "$pattern" . --exclude-dir=.git --exclude-dir=vendor --exclude="*.md" || true)
          if [ -n "$MATCHES" ]; then
            echo "âš ï¸ Potential secret found: $pattern" >> security_report.md
            echo "$MATCHES" >> security_report.md
            SECRETS_FOUND=$((SECRETS_FOUND + 1))
          fi
        done
        
        if [ $SECRETS_FOUND -eq 0 ]; then
          echo "âœ… No hardcoded secrets detected" >> security_report.md
        else
          echo "âŒ $SECRETS_FOUND potential secrets found" >> security_report.md
        fi
        
    - name: ðŸŒ Check for unsafe network calls
      run: |
        echo "" >> security_report.md
        echo "### ðŸŒ Network Security Analysis" >> security_report.md
        
        # å®‰å…¨ã§ãªã„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å‘¼ã³å‡ºã—ã‚’ãƒã‚§ãƒƒã‚¯
        UNSAFE_CALLS=$(grep -r -E "(http://|InsecureSkipVerify.*true|TLSClientConfig.*InsecureSkipVerify)" . --include="*.go" || true)
        
        if [ -n "$UNSAFE_CALLS" ]; then
          echo "âš ï¸ Potentially unsafe network calls detected:" >> security_report.md
          echo "\`\`\`" >> security_report.md
          echo "$UNSAFE_CALLS" >> security_report.md
          echo "\`\`\`" >> security_report.md
        else
          echo "âœ… No unsafe network calls detected" >> security_report.md
        fi
        
    - name: ðŸ“¤ Upload security report
      uses: actions/upload-artifact@v3
      with:
        name: security-scan-report
        path: |
          security_report.md
          gosec-report.json
        retention-days: 30

  # ===== ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯ =====
  dependency-scan:
    name: ðŸ“¦ Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ¹ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: ðŸ”§ Install dependency scan tools
      run: |
        # Go vulnerability checker
        go install golang.org/x/vuln/cmd/govulncheck@latest
        
        # Nancy for additional vulnerability checking
        go install github.com/sonatypecom/nancy@latest || echo "Nancy installation failed, continuing..."
        
    - name: ðŸ” Run Go vulnerability check
      run: |
        echo "## ðŸ“¦ Dependency Security Report" > dependency_report.md
        echo "" >> dependency_report.md
        echo "### ðŸ” Go Vulnerability Check" >> dependency_report.md
        echo "\`\`\`" >> dependency_report.md
        
        # govulncheckå®Ÿè¡Œ
        govulncheck ./... 2>&1 | tee -a dependency_report.md || true
        
        echo "\`\`\`" >> dependency_report.md
        
    - name: ðŸ“‹ Analyze dependencies
      run: |
        echo "" >> dependency_report.md
        echo "### ðŸ“‹ Dependency Analysis" >> dependency_report.md
        
        # ç›´æŽ¥ä¾å­˜é–¢ä¿‚ã®è¡¨ç¤º
        echo "#### Direct Dependencies:" >> dependency_report.md
        echo "\`\`\`" >> dependency_report.md
        go list -m all | head -20 >> dependency_report.md
        echo "\`\`\`" >> dependency_report.md
        
        # ä¾å­˜é–¢ä¿‚ã®çµ±è¨ˆ
        TOTAL_DEPS=$(go list -m all | wc -l)
        DIRECT_DEPS=$(grep -c "require" go.mod 2>/dev/null || echo "0")
        
        echo "" >> dependency_report.md
        echo "#### Statistics:" >> dependency_report.md
        echo "- **Total dependencies**: $TOTAL_DEPS" >> dependency_report.md
        echo "- **Direct dependencies**: $DIRECT_DEPS" >> dependency_report.md
        
        # å¤ã„ä¾å­˜é–¢ä¿‚ã‚’ãƒã‚§ãƒƒã‚¯
        echo "" >> dependency_report.md
        echo "#### Outdated Dependencies Check:" >> dependency_report.md
        echo "\`\`\`" >> dependency_report.md
        go list -u -m all 2>&1 | grep -E "\[.*\]" | head -10 >> dependency_report.md || echo "No outdated dependencies detected" >> dependency_report.md
        echo "\`\`\`" >> dependency_report.md
        
    - name: ðŸ”’ Check for known vulnerable packages
      run: |
        echo "" >> dependency_report.md
        echo "### ðŸš¨ Known Vulnerable Packages" >> dependency_report.md
        
        # æ—¢çŸ¥ã®è„†å¼±ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆï¼ˆä¾‹ï¼‰
        VULNERABLE_PACKAGES=(
          "github.com/gin-gonic/gin@v1.6.0"
          "github.com/gorilla/websocket@v1.4.0"
          "gopkg.in/yaml.v2@v2.2.2"
        )
        
        VULNERABILITIES_FOUND=0
        for pkg in "${VULNERABLE_PACKAGES[@]}"; do
          if go list -m all | grep -q "$(echo $pkg | cut -d'@' -f1)"; then
            CURRENT_VERSION=$(go list -m all | grep "$(echo $pkg | cut -d'@' -f1)" | awk '{print $2}')
            echo "âš ï¸ Package $(echo $pkg | cut -d'@' -f1) found (version: $CURRENT_VERSION)" >> dependency_report.md
            VULNERABILITIES_FOUND=$((VULNERABILITIES_FOUND + 1))
          fi
        done
        
        if [ $VULNERABILITIES_FOUND -eq 0 ]; then
          echo "âœ… No known vulnerable packages detected" >> dependency_report.md
        else
          echo "âŒ $VULNERABILITIES_FOUND potentially vulnerable packages found" >> dependency_report.md
        fi
        
    - name: ðŸ“¤ Upload dependency report
      uses: actions/upload-artifact@v3
      with:
        name: dependency-scan-report
        path: dependency_report.md
        retention-days: 30

  # ===== ãƒ©ã‚¤ã‚»ãƒ³ã‚¹é©åˆæ€§ãƒã‚§ãƒƒã‚¯ =====
  license-compliance:
    name: âš–ï¸ License Compliance
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ¹ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: ðŸ”§ Install license checking tools
      run: |
        # Go-licenses for license detection
        go install github.com/google/go-licenses@latest || echo "go-licenses installation failed"
        
    - name: âš–ï¸ Analyze licenses
      run: |
        echo "## âš–ï¸ License Compliance Report" > license_report.md
        echo "" >> license_report.md
        echo "### ðŸ“‹ Project License" >> license_report.md
        
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç¢ºèª
        if [ -f "LICENSE" ]; then
          echo "âœ… Project license file found:" >> license_report.md
          echo "\`\`\`" >> license_report.md
          head -5 LICENSE >> license_report.md
          echo "\`\`\`" >> license_report.md
        else
          echo "âš ï¸ No LICENSE file found in project root" >> license_report.md
        fi
        
        echo "" >> license_report.md
        echo "### ðŸ“¦ Dependency Licenses" >> license_report.md
        
        # ä¾å­˜é–¢ä¿‚ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ï¼ˆgo-licensesãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
        if command -v go-licenses >/dev/null 2>&1; then
          echo "\`\`\`" >> license_report.md
          go-licenses report . 2>&1 | head -20 >> license_report.md || echo "License detection failed" >> license_report.md
          echo "\`\`\`" >> license_report.md
        else
          echo "License scanning tool not available" >> license_report.md
        fi
        
        # äº’æ›æ€§ã®ãªã„ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
        echo "" >> license_report.md
        echo "### âš ï¸ License Compatibility Check" >> license_report.md
        
        INCOMPATIBLE_LICENSES=(
          "GPL-3.0"
          "AGPL-3.0"
          "SSPL-1.0"
        )
        
        ISSUES_FOUND=0
        for license in "${INCOMPATIBLE_LICENSES[@]}"; do
          if go-licenses report . 2>/dev/null | grep -q "$license"; then
            echo "âŒ Potentially incompatible license found: $license" >> license_report.md
            ISSUES_FOUND=$((ISSUES_FOUND + 1))
          fi
        done
        
        if [ $ISSUES_FOUND -eq 0 ]; then
          echo "âœ… No license compatibility issues detected" >> license_report.md
        else
          echo "âš ï¸ $ISSUES_FOUND potential license compatibility issues" >> license_report.md
        fi
        
    - name: ðŸ“¤ Upload license report
      uses: actions/upload-artifact@v3
      with:
        name: license-compliance-report
        path: license_report.md
        retention-days: 30

  # ===== ä¾å­˜é–¢ä¿‚æ›´æ–°ææ¡ˆ =====
  dependency-update:
    name: ðŸ”„ Dependency Update Recommendations
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 6 * * 1'  # æ¯Žé€±æœˆæ›œæ—¥ã®ã¿å®Ÿè¡Œ
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ¹ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: ðŸ” Check for updates
      run: |
        echo "## ðŸ”„ Dependency Update Recommendations" > update_recommendations.md
        echo "" >> update_recommendations.md
        echo "### ðŸ“¦ Available Updates" >> update_recommendations.md
        echo "\`\`\`" >> update_recommendations.md
        
        # æ›´æ–°å¯èƒ½ãªä¾å­˜é–¢ä¿‚ã‚’ãƒã‚§ãƒƒã‚¯
        go list -u -m all | grep -E "\[.*\]" >> update_recommendations.md || echo "All dependencies are up to date" >> update_recommendations.md
        
        echo "\`\`\`" >> update_recommendations.md
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã‚’ç‰¹ã«æ³¨æ„
        echo "" >> update_recommendations.md
        echo "### ðŸš¨ Security Updates" >> update_recommendations.md
        echo "Please prioritize these updates if they contain security fixes:" >> update_recommendations.md
        
        # go.mod ã§ pinned ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
        if [ -f "go.mod" ]; then
          PINNED_VERSIONS=$(grep -E "v[0-9]+\.[0-9]+\.[0-9]+" go.mod | wc -l)
          echo "" >> update_recommendations.md
          echo "### ðŸ“Œ Pinned Versions" >> update_recommendations.md
          echo "- **Pinned dependencies**: $PINNED_VERSIONS" >> update_recommendations.md
        fi
        
        echo "" >> update_recommendations.md
        echo "### ðŸŽ¯ Update Strategy" >> update_recommendations.md
        echo "1. **Major version updates**: Review breaking changes carefully" >> update_recommendations.md
        echo "2. **Security patches**: Apply immediately" >> update_recommendations.md
        echo "3. **Minor updates**: Test in development environment first" >> update_recommendations.md
        echo "4. **AI/ML libraries**: Verify compatibility with learning objectives" >> update_recommendations.md
        
    - name: ðŸ“¤ Upload update recommendations
      uses: actions/upload-artifact@v3
      with:
        name: dependency-update-recommendations
        path: update_recommendations.md
        retention-days: 30

  # ===== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆçµ±åˆ =====
  security-summary:
    name: ðŸ“‹ Security Summary
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-scan, license-compliance, dependency-update]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate Security Summary
      run: |
        echo "# ðŸ”’ Security & Dependency Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“‹ Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Security Scan**: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Dependency Scan**: ${{ needs.dependency-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **License Compliance**: ${{ needs.license-compliance.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Dependency Updates**: ${{ needs.dependency-update.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ…‹ã®ç·åˆè©•ä¾¡
        if [ "${{ needs.security-scan.result }}" = "success" ] && [ "${{ needs.dependency-scan.result }}" = "success" ] && [ "${{ needs.license-compliance.result }}" = "success" ]; then
          echo "## âœ… Overall Security Status: SECURE" >> $GITHUB_STEP_SUMMARY
          echo "All security checks passed successfully!" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âš ï¸ Overall Security Status: ATTENTION REQUIRED" >> $GITHUB_STEP_SUMMARY
          echo "Some security issues detected. Please review the detailed reports." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ›¡ï¸ Security Best Practices" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Regular vulnerability scanning" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Dependency update monitoring" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… License compliance checking" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Secret detection and prevention" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“ Available Reports" >> $GITHUB_STEP_SUMMARY
        echo "- Security vulnerability scan results" >> $GITHUB_STEP_SUMMARY
        echo "- Dependency analysis and recommendations" >> $GITHUB_STEP_SUMMARY
        echo "- License compliance verification" >> $GITHUB_STEP_SUMMARY
        echo "- Weekly dependency update suggestions" >> $GITHUB_STEP_SUMMARY