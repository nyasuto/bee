#!/bin/sh
# Bee ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯ã¨ãƒ–ãƒ©ãƒ³ãƒãƒ«ãƒ¼ãƒ«ã‚’å¼·åˆ¶

set -e

echo "ğŸ Bee Pre-commit ãƒ•ãƒƒã‚¯å®Ÿè¡Œä¸­..."

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

# mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ç›´æ¥ã‚³ãƒŸãƒƒãƒˆç¦æ­¢
if [ "$current_branch" = "main" ]; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ç›´æ¥ã‚³ãƒŸãƒƒãƒˆã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"
    echo "   æ©Ÿèƒ½ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã¦ãã ã•ã„:"
    echo "   git checkout -b feat/phase1-perceptron"
    echo "   git checkout -b fix/issue-X-description"
    exit 1
fi

# ãƒ–ãƒ©ãƒ³ãƒå‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒä»¥å¤–ï¼‰
if [ "$current_branch" != "main" ]; then
    valid_patterns="^(feat|fix|hotfix|test|docs|ci|cicd|refactor|perf|security|deps|claude)/"
    if ! echo "$current_branch" | grep -qE "$valid_patterns"; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒåãŒå‘½åè¦å‰‡ã«å¾“ã£ã¦ã„ã¾ã›ã‚“: $current_branch"
        echo "   æ­£ã—ã„å½¢å¼ (Bee ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨):"
        echo "   - feat/phase1-perceptron         (Phase 1å®Ÿè£…)"
        echo "   - feat/phase2-cnn               (Phase 2å®Ÿè£…)"
        echo "   - fix/issue-X-description       (ãƒã‚°ä¿®æ­£)"
        echo "   - hotfix/X-description          (ç·Šæ€¥ä¿®æ­£)"
        echo "   - test/X-description            (ãƒ†ã‚¹ãƒˆ)"
        echo "   - docs/X-description            (ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)"
        echo "   - ci/X-description              (CI/CD)"
        echo "   - refactor/X-description        (ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°)"
        echo "   - perf/X-description           (æ€§èƒ½æ”¹å–„)"
        echo "   - security/X-description        (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)"
        echo "   - deps/X-description           (ä¾å­˜é–¢ä¿‚)"
        echo "   - claude/X-description          (Claude Codeä½œæ¥­)"
        exit 1
    fi
fi

# ç©ºã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯
if [ -z "$(git diff --cached --name-only)" ]; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚ŒãŸå¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
    exit 1
fi

# å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
echo "ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
make quality

# Makefileã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆ
makefile_changed=$(git diff --cached --name-only | grep -E '^Makefile$' || true)
if [ -n "$makefile_changed" ]; then
    echo "ğŸ”§ Makefileæ§‹æ–‡ãƒã‚§ãƒƒã‚¯..."
    if ! make -n help >/dev/null 2>&1; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: Makefileæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™"
        exit 1
    fi
fi

echo "âœ… Bee Pre-commit ãƒã‚§ãƒƒã‚¯å®Œäº†"